var debug=!0,log=function(a){debug&&console.log(a)},percentChg=function(a,e){return 0!==e?(a-e)/(a+e)*100:0};Number.prototype.format=function(a,e,i,n){var o="\\d(?=(\\d{"+(e||3)+"})+"+(a>0?"\\D":"$")+")",r=this.toFixed(Math.max(0,~~a));return(n?r.replace(".",n):r).replace(new RegExp(o,"g"),"$&"+(i||","))};var abbrState=function(a,e){var n=[["Arizona","AZ"],["Alabama","AL"],["Alaska","AK"],["Arizona","AZ"],["Arkansas","AR"],["California","CA"],["Colorado","CO"],["Connecticut","CT"],["Delaware","DE"],["Florida","FL"],["Georgia","GA"],["Hawaii","HI"],["Idaho","ID"],["Illinois","IL"],["Indiana","IN"],["Iowa","IA"],["Kansas","KS"],["Kentucky","KY"],["Kentucky","KY"],["Louisiana","LA"],["Maine","ME"],["Maryland","MD"],["Massachusetts","MA"],["Michigan","MI"],["Minnesota","MN"],["Mississippi","MS"],["Missouri","MO"],["Montana","MT"],["Nebraska","NE"],["Nevada","NV"],["New Hampshire","NH"],["New Jersey","NJ"],["New Mexico","NM"],["New York","NY"],["North Carolina","NC"],["North Dakota","ND"],["Ohio","OH"],["Oklahoma","OK"],["Oregon","OR"],["Pennsylvania","PA"],["Rhode Island","RI"],["South Carolina","SC"],["South Dakota","SD"],["Tennessee","TN"],["Texas","TX"],["Utah","UT"],["Vermont","VT"],["Virginia","VA"],["Washington","WA"],["West Virginia","WV"],["Wisconsin","WI"],["Wyoming","WY"]];if("abbr"==e){for(a=a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),i=0;i<n.length;i++)if(n[i][0]==a)return n[i][1]}else if("name"==e)for(a=a.toUpperCase(),i=0;i<n.length;i++)if(n[i][1]==a)return n[i][0]};
var map,gmap=function(o){"use strict";function n(){log("gmap.init() loaded"),l.mapcanvas=o(".js-gmap"),l.mapcanvas.length?a():log("gmap.init(): no mapcanvas found")}function a(){var o=document.createElement("script");o.type="text/javascript",o.id="new-gmap",o.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAF1sRGF7ku7L3dKictevzxUTPWc2YF6NI&callback=gmap.build",document.body.appendChild(o)}function e(){var n=o.extend({},l.mapDefaults,{zoom:l.zoom,center:new google.maps.LatLng(l.latCenter,l.lonCenter),zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},maxZoom:l.maxZoom,minZoom:l.minZoom,styles:[]});map=new google.maps.Map(l.mapcanvas[0],n)}function t(o,n,a){var e=new google.maps.Geocoder,t=[];e.geocode({address:n},function(n,e){e==google.maps.GeocoderStatus.OK&&(t[0]=n[0].geometry.location.lat(),t[1]=n[0].geometry.location.lng(),r[o]=t,p(t,o,a))})}function m(o){var n=r[o][0],a=r[o][1],e=new google.maps.LatLng(n,a);map.panTo(e),map.setZoom(6)}function i(){var o=new google.maps.LatLng(37.09024,-96.712891);map.panTo(o),map.setZoom(4)}function p(o,n,a){var e=new google.maps.InfoWindow({content:a}),t=new google.maps.Marker({position:{lat:o[0],lng:o[1]},map:map,title:n,infowindow:e});c.push(t),google.maps.event.addListener(t,"click",function(){s(),this.infowindow.open(map,this)})}function s(){c.map(function(o){o.infowindow.close()})}var l={mapDefaults:{panControl:!1,zoomControl:!0,zoomControlOptions:!0,scaleControl:!1,mapTypeControl:!1,streetViewControl:!1,scrollwheel:!1,zoom:4,maxZoom:16,minZoom:3},mapcanvas:0,latCenter:37.09024,lonCenter:-96.712891},r=[],c=[];return{init:n,build:e,buildMarkers:t,removeMarkers:s,moveToLocation:m,zoomOut:i}}(jQuery);
var makeAjax=function(a){"use strict";function e(e,t,n,o){a.ajax({url:t,method:"GET",dataType:"json",success:function(a){getData.getAreaData(e,a,n,o)},error:function(){log("fail to get code")}})}function t(e,n,o,c,i,r){c>=2||setTimeout(function(){-1===c?(log("make sync request: initialize -1 to negate setTimeout effect"),c+=1,a.ajax({url:n[c+1],success:function(a){t(e,n,o,c,i,r),getData.cleanData(e,a,o[c],i,r)},error:function(){log("initialize sync ajax failed: "+c),log("moving on to new ajax for next data:"),t(e,n,o,c,i,r)}})):(log("make sync request: "+c),a.ajax({url:n[c],method:"GET",dataType:"json",success:function(a){getData.cleanData(e,a,o[c],i,r),c+=1,t(e,n,o,c,i,r)},error:function(){log("load data failed: "+c+"for"+o[c]),log("moving on to new ajax for next data:"),c+=1,t(e,n,o,c,i,r)}}))},1e3)}return{sync:t,asyncGetCode:e}}(jQuery);
var getData=function(e){"use strict";function a(e,a,r){void 0===e&&(e="All States"),void 0===a&&(a=10),void 0===r&&(r="HousePrice"),p!==e&&("All States"===e?gmap.zoomOut():gmap.moveToLocation(e),p=e),t(e,a,r)}function t(a,t,o){e.support.cors=!0,"All States"===a?e.isEmptyObject(s)?makeAjax.asyncGetCode(a,"state_code.json",t,o):r(a,s,t,o):(log("get area codes"),e.isEmptyObject(l)?makeAjax.asyncGetCode(a,"neighborhood_code.json",t,o):r(a,l,t,o))}function r(a,t,r,o){var p;if("All States"===a){if(!e.isEmptyObject(n)){log("state data already exists");for(var d in n)i(a,n,d,r,o);return}s=t,p="S"}else{if(log("get area data"),!e.isEmptyObject(c[a])){log("area data already exists"),gmap.removeMarkers();for(var g in c[a])log(c),i(a,c,g,r,o);return}c[a]={},l=t;for(var u in l){var v=l[u]["City|Code"].split("|");l[u].Code=v[1]}p="N"}var y,m=["https://www.quandl.com/api/v3/datasets/ZILL/",p,"@areaCode_A.json?collapse=annual","&api_key=1aGVznRZH7ckoyhVtges"],C=[],f=[];if("All States"===a)for(var h in s)y=m.join("").replace("@areaCode",s[h]),C.push(y),f.push(h);else for(var j in l){var A=abbrState(a,"abbr");l[j].Metro===A&&(y=m.join("").replace("@areaCode",l[j].Code),C.push(y),f.push(j))}makeAjax.sync(a,C,f,-1,r,o)}function o(e,a,t,r,o){var s,l=a.dataset.data,p={HousePriceYr1:l[0][1],HousePriceYr3:2 in l?l[2][1]:0,HousePriceYr5:4 in l?l[4][1]:0,HousePriceYr10:9 in l?l[9][1]:0,PriceChangeYr1:percentChg(l[0][1],l[1][1]),PriceChangeYr3:percentChg(l[0][1],2 in l?l[2][1]:0),PriceChangeYr5:percentChg(l[0][1],4 in l?l[4][1]:0),PriceChangeYr10:percentChg(l[0][1],9 in l?l[9][1]:0)};"All States"===e?(n[t]=p,s=n):(c[e][t]=p,s=c),i(e,s,t,r,o)}function i(e,a,t,r,o){var i="All States"===e?t:e,s=t+" "+i+" United States",n=["Place: @place <br>","@dataType: @displayData <br>","Data over: @time years"],l=o+"Yr"+r;log("display data key: "+l);var c="All States"===e?a:a[e],p=c[t][l],d=0===p?"no data":p.format(0,3,",");log(d),"HousePrice"===o&&(d="$"+d),"PriceChange"===o&&(d+="%"),n=n.join("").replace("@place",t).replace("@dataType",o).replace("@displayData",d).replace("@time",r),gmap.buildMarkers(t,s,n)}var s={},n={},l={},c={},p="All States";return{from:a,getAreaData:r,cleanData:o}}(jQuery);
!function(t){"use strict";log("app loaded"),function(){t(".js-search-location").submit(function(e){e.preventDefault();var a=t("#js-data-type option:selected").val(),o=t("#js-year option:selected").val(),s=t("#js-state option:selected").val();gmap.removeMarkers(),getData.from(s,o,a)})}(),gmap.init(),getData.from("All States")}(jQuery);